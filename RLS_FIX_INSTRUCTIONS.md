# Исправление ошибок RLS в Supabase

## Проблемы
1. `public.push_subscriptions` - отсутствует RLS
2. `public.spatial_ref_sys` - отсутствует RLS  
3. `public.push_subscriptions` - уязвимый столбец `auth_key`

## Решения

### 1. Применение исправлений

Выполните SQL файлы в Supabase Dashboard в следующем порядке:

#### Вариант А: Полное обновление (рекомендуется)
```sql
-- Выполните содержимое файла supabase_policies.sql
-- Он уже обновлен и включает политики для push_subscriptions
```

#### Вариант Б: Быстрое исправление
```sql
-- Выполните fix_rls_policies.sql
-- Затем выполните fix_spatial_ref_sys.sql
```

### 2. Что делают исправления

#### Для push_subscriptions:
- ✅ Включает Row Level Security
- ✅ Создает политику: пользователи могут управлять только своими подписками
- ✅ Создает безопасную функцию для отправки уведомлений без раскрытия auth_key
- ✅ Добавляет таблицу в realtime публикацию

#### Для spatial_ref_sys:
- ✅ Включает Row Level Security  
- ✅ Создает политику публичного чтения (системная таблица PostGIS)

### 3. Безопасность auth_key

Столбец `auth_key` теперь защищен:
- Прямой доступ к таблице ограничен политикой RLS
- Создана функция `get_push_subscription_for_notification()` которая не возвращает auth_key
- Для доступа к auth_key нужно использовать отдельную защищенную функцию

### 4. Проверка

После применения исправлений:
1. Проверьте, что ошибки в Supabase Dashboard исчезли
2. Протестируйте push-уведомления
3. Убедитесь, что пользователи могут управлять только своими подписками

### 5. Применение в Supabase Dashboard

1. Откройте Supabase Dashboard
2. Перейдите в SQL Editor
3. Скопируйте и выполните SQL из обновленного `supabase_policies.sql`
4. Проверьте отсутствие ошибок в разделе Authentication → Policies
